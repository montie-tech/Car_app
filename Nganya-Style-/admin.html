<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin – Driver Applications</title>

<style>
body { font-family: Poppins, sans-serif; padding: 20px; background: #f4f4f4; }
h1 { margin-bottom: 20px; }
.card { background: #ffffff; padding: 20px; border-radius: 10px; margin: 20px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

.section-header {
    background: #bd9808ff;
    color: #fff;
    padding: 10px 15px;
    border-radius: 6px;
    margin-bottom: 10px;
    font-size: 1.2rem;
}

button { padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; }
.approve { background: #28a745; color: #fff; margin-right: 10px; }
.reject { background: #dc2410ff; color: #fff; }

.list-item { padding: 10px; border-bottom: 1px solid #ddd; }

/* Notification popup */
#notifyBox {
    position: fixed;
    top: 20px;
    right: -400px;
    background: #0d6efd;
    color: white;
    padding: 15px 20px;
    border-radius: 10px;
    transition: 0.4s;
    font-weight: bold;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

footer {
  background: #222;
  color: white;
  text-align: center;
  padding: 5px;
  margin-top: 20px;
  font-size: 1rem;
  margin-left: -28px;
  margin-right: -29px;
}
</style>
</head>

<body>
<h1>Admin Dashboard – Nganya</h1>

<!-- Notification Popup -->
<div id="notifyBox">New driver application received!</div>

<audio id="alertSound">
    <source src="https://assets.mixkit.co/active_storage/sfx/2000/2000.wav" type="audio/wav">
</audio>

<!-- PENDING -->
<div class="card">
    <div class="section-header">Pending Applications</div>
    <div id="pendingList"></div>
</div>

<!-- APPROVED -->
<div class="card">
    <div class="section-header" style="background:#28a745;">Approved Drivers</div>
    <div id="approvedList"></div>
</div>

<!-- REJECTED -->
<div class="card">
    <div class="section-header" style="background:#dc2410ff;">Rejected Applications</div>
    <div id="rejectedList"></div>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
/* -------------------------- CONFIG -------------------------- */
const API = "http://localhost:5000/api";
const socket = io("http://localhost:5000");

/* -------------------------- NOTIFICATION -------------------------- */
function showNotification() {
    const box = document.getElementById("notifyBox");
    const sound = document.getElementById("alertSound");

    box.style.right = "20px";
    sound.play();

    setTimeout(() => { box.style.right = "-400px"; }, 3000);
}

/* -------------------------- LOAD APPLICATIONS -------------------------- */
async function loadApplications() {
    try {
        const res = await fetch(`${API}/drivers/all`);
        const data = await res.json();

        let pending = "";
        let approved = "";
        let rejected = "";

        data.forEach(app => {
            let block = `
            <div class="list-item">
                <b>${app.name}</b> – ${app.vehicle || '---'} – ${app.route || '---'}<br>
                Phone: ${app.phone} — Capacity: ${app.capacity || '---'}<br>`;

            if (app.status === "pending") {
                block += `
                    <button class="approve" onclick="approve('${app._id}')">Approve</button>
                    <button class="reject" onclick="rejectApp('${app._id}')">Reject</button>
                `;
                pending += block + "</div>";
            }

            if (app.status === "approved") {
                approved += block + "</div>";
            }

            if (app.status === "rejected") {
                block += `<br><i>Reason: ${app.rejectReason || "No reason provided"}</i>`;
                rejected += block + "</div>";
            }
        });

        document.getElementById("pendingList").innerHTML = pending || "<i>No pending applications</i>";
        document.getElementById("approvedList").innerHTML = approved || "<i>No approved drivers</i>";
        document.getElementById("rejectedList").innerHTML = rejected || "<i>No rejected applications</i>";

    } catch (error) {
        alert("Error loading applications");
        console.log(error);
    }
}

/* -------------------------- APPROVE -------------------------- */
async function approve(id) {
    try {
        const res = await fetch(`${API}/drivers/approve`, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ driverId: id })
        });

        const result = await res.json();
        if (!result.success) return alert(result.message);

        loadApplications();
    } catch (error) {
        alert("Failed to approve driver");
        console.log(error);
    }
}

/* -------------------------- REJECT -------------------------- */
async function rejectApp(id) {
    const reason = prompt("Reason for rejection:");

    if (!reason || reason.trim() === "") {
        alert("Rejection cancelled. Reason cannot be empty.");
        return;
    }

    try {
        const res = await fetch(`${API}/drivers/reject`, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ driverId: id, reason })
        });

        const result = await res.json();
        if (!result.success) return alert(result.message);

        loadApplications();

    } catch (error) {
        alert("Failed to reject driver");
        console.log(error);
    }
}

/* -------------------------- SOCKET EVENTS -------------------------- */
socket.on("newApplication", () => {
    showNotification();
    loadApplications();
});

/* -------------------------- INITIAL LOAD -------------------------- */
loadApplications();
</script>

<footer>
    <p>© 2025 Nganya App</p>
</footer>

</body>
</html>
